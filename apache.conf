# Apache Configuration for Saudi Cyber Security Tool
# Reverse Proxy with mod_wsgi and Security Headers

<VirtualHost *:80>
    ServerName localhost
    Redirect permanent / https://localhost/
</VirtualHost>

<VirtualHost *:443>
    ServerName localhost
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/saudi-cyber-cert.pem
    SSLCertificateKeyFile /etc/ssl/private/saudi-cyber-key.pem
    SSLCertificateChainFile /etc/ssl/certs/saudi-cyber-chain.pem
    
    # Security Protocols
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' cdn.jsdelivr.net;"
    
    # Hide server information
    ServerTokens Prod
    ServerSignature Off
    
    # Gzip compression
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.pdf$ no-gzip dont-vary
    </Location>
    
    # Rate limiting
    LoadModule ratelimit_module modules/mod_ratelimit.so
    SetOutputFilter RATE_LIMIT
    SetEnv rate-limit 100
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Main application proxy
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:8000/$1" [P,L]
    
    # Static files (if served directly by Apache)
    DocumentRoot /home/saudi-cyber-tool/static
    <Directory /home/saudi-cyber-tool/static>
        Options -Indexes
        AllowOverride None
        Require all granted
        
        # Cache static files
        ExpiresActive On
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
    </Directory>
    
    # Security restrictions
    <Directory />
        Require all denied
    </Directory>
    
    # Block sensitive files
    <Files ~ "^\.">
        Require all denied
    </Files>
    
    <Files ~ "\.(py|log|ini|conf|env)$">
        Require all denied
    </Files>
    
    # Logging
    LogLevel warn
    ErrorLog /var/log/apache2/saudi-cyber-error.log
    CustomLog /var/log/apache2/saudi-cyber-access.log combined
    
    # Health check
    <Location /health>
        SetHandler none
        Require all granted
    </Location>
</VirtualHost>

# mod_wsgi configuration (alternative to reverse proxy)
# LoadModule wsgi_module modules/mod_wsgi.so
# WSGIDaemonProcess saudi-cyber-tool python-path=/home/saudi-cyber-tool
# WSGIProcessGroup saudi-cyber-tool
# WSGIScriptAlias / /home/saudi-cyber-tool/wsgi.py